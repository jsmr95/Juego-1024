<!DOCTYPE html>
<html lang="es" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="estilos.css">
    <title></title>
    <script type="text/javascript">
      window.onload = function(){
        //array de cuadrados totales y de los que quedan vacios
        var cuadrados = document.getElementsByTagName('td');
        var vacios = generaVacios(cuadrados);
        //Columnas y filas
        // var columna1 = document.getElementsById('col1');
        // var columna2 = document.getElementsById('col2');
        // var columna3 = document.getElementsById('col3');
        // var columna4 = document.getElementsById('col4');
        // var filas = document.getElementsById('fila');
        // console.log(filas);
        window.addEventListener('click',reduceColumnaAbajo);
        generaNumero();
        generaNumero();

        //detecta cuales estan vacios de entre los totales
        function generaVacios(cuadrados){
          var vacios = [];
          for (var i = 0; i < cuadrados.length; i++) {
            if (cuadrados[i].childNodes.length == 1) {
              vacios.push(cuadrados[i]);
            }
          }
          return vacios;
        }

        //genera un 2 o 4 aleatoriamente y lo pinta entre los vacio aleatoriamente
        function generaNumero(){
          var num = 2;
          var aleatorio = Math.random();
          var aleatorio1 = Math.floor(Math.random()*vacios.length);
          if (aleatorio >= 0.7) {
            num = 4;
          }
            var p = document.createElement('p');
            p.appendChild(document.createTextNode(num));
            p.setAttribute('class',`c${num}`);
            vacios[aleatorio1].appendChild(p);
            actualizaVacios();
        }

        //funcion para reducir columna abajo
        function reduceColumnaAbajo(){
          var c1 = document.getElementById('col1');
          var c2 = document.getElementById('col12');
          var c3 = document.getElementById('col13');
          var c4 = document.getElementById('col14');
          var columnas = [c4,c3,c2,c1];
          // var llenos = columnas.filter(elem => !vacio(elem));
          // if (llenos.length == 1) {
          //   mueveNodo(llenos[0], c4);
          // }else {
            var cont = 0;
            for (var i = 0; i < columnas.length; i--) {
                if (!vacio(columnas[i])) {

                }
                if (compara(columnas[i], columnas[i+1]) && cont == 0) {
                    transformaNodo(columnas[i]);
                    mueveNodo(columnas[i],columnas[i+1]);
                    cont++;
                }
            }
        // }

        }

        function compara(nodo1,nodo2){ return nodo1.children[0].firstChild.nodeValue == nodo2.children[0].firstChild.nodeValue;}
        function vacio(nodo){return nodo.children.length == 0;}
        function transformaNodo(nodo){ nodo.children[0].firstChild.nodeValue = nodo.children[0].firstChild.nodeValue*2;}
        function mueveNodo(nodo, lugar){ lugar.replaceChild(nodo.firstChild,lugar.firstChild); }
        function actualizaVacios(){vacios = generaVacios(cuadrados); }
      }
    </script>
  </head>
  <body>
    <center>
    <table>
        <tbody id="cuerpo">
            <tr id="fila1">
                <td id="col1"  name='cuadrado'><p>2</p> </td>
                <td id="col21"  name='cuadrado'> </td>
                <td id="col31"  name='cuadrado'> </td>
                <td id="col41"  name='cuadrado'> </td>
            </tr>
            <tr id="fila2">
                <td id="col12"  name='cuadrado'><p>2</p> </td>
                <td id="col22"  name='cuadrado'> </td>
                <td id="col32"  name='cuadrado'> </td>
                <td id="col42"  name='cuadrado'> </td>
            </tr>
            <tr id="fila3">
                <td id="col13"  name='cuadrado'> </td>
                <td id="col23"  name='cuadrado'> </td>
                <td id="col33"  name='cuadrado'> </td>
                <td id="col43"  name='cuadrado'> </td>
            </tr>
            <tr id="fila4" >
                <td id="col14"  name='cuadrado'> </td>
                <td id="col24" name='cuadrado'> </td>
                <td id="col34"  name='cuadrado'> </td>
                <td id="col44"  name='cuadrado'> </td>
            </tr>
        </tbody>
    </table>
    </center>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </body>
</html>
